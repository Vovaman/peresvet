# Описание
**Пересвет** - платформа для автоматизации технических объектов. Сбор данных, хранение, обработка, 
выполнение определённых действий на базе происходящих событий.

Отличия от баз данных реального времени (Prometheus, VictoriaMetrics и т.д.):
1. Инфраструктура. Платформа представляет собой, в первую очередь, инфраструктурную надстройку над базой данных реального времени, 
   т.е. предлагает создание иерархии объектов, каждый из которых обладает набором параметров (тэгов).
2. Расчётные тэги. У объекта могут быть параметры, которые рассчитываются на основании других параметров.
3. Внешние расчётные методы. К событиям, происходящим в платформе (изменения тэгов; тревоги; расписания) могут быть привязаны как 
   расчётные методы тэгов, так и просто внешние методы, запускающие какие-либо внешние процессы.
4. Платформа позволяет не только собирать внешние данные, но и записывать (через коннекторы) данные во внешние источники.
   Таким образом, на базе платформы можно строить SCADA-системы, системы управления умным домом и т.д.
Говоря в общем, платформа Пересвет, в отличие от большинства баз данных реального времени, нацелена не столько на сбор метрик,
сколько на автоматизацию технических объектов.
# Использование
1. Устанавливаем **Пересвет**. В качестве хранилища данных используется [Victoriametrics](https://victoriametrics.com/). 
   В качестве приложения для отображения данных - [Grafana](https://grafana.com/).
2. Создаём в платформе иерархию объектов с параметрами, либо просто список параметров. 
3. К параметрам привязываем поставщиков данных (коннекторы).
4. Запускаем Grafana, создаём панели для просмотра данных. В качестве источника данных указываем VictoriaMetrics.
   > В дальнейшем будет написан собственный DataSource для Grafana.

Подробно все шаги описаны в документации, разделы "Концепция" и "Установка".

# Отладка
**Пересвет** разрабатывается с использованием VSCode, поэтому отладка описана применительно к этому инструменту.

Для отладки в VSCode должен быть установлен плагин `ms-vscode-remote.remote-containers`.

Отладка настроена по рецепту, предложенному https://github.com/Kludex/fastapi-docker-debug.

Запуск отладки:
1. Создаем в VSCode новый терминал: `Terminal -> New terminal` (`Терминал -> Создать терминал`).
2. В терминале выполняем команду: ```$ docker-compose -f docker-compose.yml -f docker-compose.debug.yml up```
3. Нажимаем `F5`...
4. Мы вошли в режим отладки приложения.

# Запуск тестов
Находясь в корневой папке проекта, запускаем файл `run_tests.sh`.

Будут запущены все тесты, также будет показана статистика покрытия тестами исходных кодов проекта.

В модуле `ldap3` есть проблема при работе в режиме mock-сервера: объект `Connection` в режиме работы
`MOCK_SYNC` возвращает результат в другом формате, нежели при нормальной работе.

Поэтому для прогона тестов создаётся дополнительный контейнер и каждый раз при новом запуске тестов 
удаляются данные, записанные во время предыдущего теста.

После прогона тестов можно подсоединиться к ldap-серверу, на котором прогонялись тесты. Он доступен по порту `3890`.
Сервис, на котором работает тестовый ldap-сервер, называется `ldap_test`.
# Приблизительный план разработки
## Первый этап
1. В качестве базы данных реального времени используем [Victoriametrics](https://victoriametrics.com/).
2. Web-клиент для просмотра данных - [Grafana](https://grafana.com/).
3. Grafana забирает данные непосредственно из VictoriaMetrics, минуя **Пересвет**.
4. Параметры (тэги) хранятся линейным списком, иерархия объектов не поддерживается.
## Второй этап
1. Создание типового коннектора как поставщика данных.
2. Создание на базе типового - коннектора для контроллера ESP32.
3. Реальный рабочий пример - отдельный проект для мониторинга и управления насосной станцией.
## Третий этап
Дальнейшее развитие функциональности:
1. Иерархия объектов.
2. Расчётные тэги.
3. Использование других TSDB.
4. Одновременное использование нескольких хранилищ.
5. Работа с камерами.
6. И т.д.

