Хранилища данных
================
Платформа поддерживает два типа хранилищ данных:

#. PostgreSQL
#. Victoriametrics

Предпочтительным хранилищем данных является PostgreSQL.

PostgreSQL
++++++++++
При создании хранилища данных на базе PostgreSQL в атрибуте
`prsJsonConfigString` должно передаваться строковое представление
json-объекта с ключом ``dsn``:

``{"dsn":"postgres://<user>:<password>@<server>:<port>/<database>}``

Например:

``{"dsn":"postgres://postgres:some_pwd@postgres:5433/peresvet}``

В момент создания в иерархии нового хранилища данных указанный сервер
должен быть доступен, а база данных - создана.

При создании нового тега в базе данных создаётся новая таблица, имя которой
совпадает с ``id`` тега.

В таблице создаются поля:

``id`` - идентификатор записи

.. table:: Таблица в базе PostgreSQL для хранения значений тега

    ========= ========= =================================================
     Колонка     Тип     Описание
    ========= ========= =================================================
     Id        bigint    Идентификатор записи. Автоинкрементное поле.
     x         bigint    Метка времени для значения.

                         Количество микросекунд

                         с 1 января 1970 00:00:00 UTC.

                         Все значения меток времени хранятся в UTC.
     y         bigint    Значение тега.

               double

               string

               json
     q         int       Код качества значения тега.
    ========= ========= =================================================

Каждый тег в своём атрибуте ``prsStore`` должен иметь строковое представление
json-объекта с ключом ``table``. Значение ключа - имя таблицы, в которой
хранятся значения тэга.

Victoriametrics
+++++++++++++++
При создании хранилища данных на базе Victoriametrics в атрибуте
`prsJsonConfigString` должно передаваться строковое представление
json-объекта с ключами ``putUrl`` и ``getUrl``:

``{"putUrl": "<url>", "getUrl": "url"}``.

Например:

``{"putUrl": "http://vm:4242/api/put", "getUrl": "http://vm:8428/api/v1/export"}``.

При этом в ключе ``putUrl`` используется url для записи данных
в Victoriametrics, а в ключе ``getUrl`` - url для чтения данных.

.. note::
   Подробнее см. документацию
   на `VictoriaMetrics <https://docs.victoriametrics.com/>`_.

Каждый тег в своём атрибуте ``prsStore`` должен иметь строковое представление
json-объекта с ключами ``metric`` и ``tags``.

Например:

``{"metric": "Uab", "tags": {"workshop": "Main", "area": "Area1", "machine": "HERMLE"}}``

Правила работы с хранилищами данных
+++++++++++++++++++++++++++++++++++
1. При создании хранилища данных в модели, а также во время работы платформы
   хранилище может быть недоступно. Доступность хранилища должна быть
   обеспечена только в момент записи или чтения данных.
