Настройка Grafana для работы с платформой Пересвет
==================================================

Для связи между Grafana и платформой необходимо произвести несколько настроек

#. Запускаем все необходимые сервисы платформы Пересвет в Docker
#. Запустить Grafana с плагином формы ручного ввода в Docker

   #. Для этого необходимо скачать проект.
   #. Сначала перейдите в директорию, где будет лежать проект плагина для Grafana.
   #. Затем скачайте его с помощью команды `gh repo clone mp-co-ru/grafana-ui-plugin`
   #. Откройте проект в VSCode и перейдите в терминал.
   #. Из корневой директории проекта запустите команду `docker compose -f docker-compose.yml up`.
   #. Дождитесь пока контейнер запустится полностью.

#. Перейдите в браузер и откройте https://localhost:3000/login
#. В форме авторизации введите `admin` в качестве пользователя и `admin` в качестве пароля.

Подключение к платформе по протоколу MQTT
=========================================

Настройка источника данных в Grafana
------------------------------------

Для получения метрик из платформы необходимо воспользоваться плагином для Grafana,
который позволяет подключаться к брокеру сообщений по протоколу MQTT

* Для установки плагина нужно перейти в раздел `plugins` и ввести в поиске mqtt.

.. figure:: ../pics/grafana_setup_plugins_menu.png
    :align: center

    Меню плагинов

.. figure:: ../pics/grafana_setup_search_plugin.png
    :align: center

    Посик MQTT плагина

* Выбираем появившийся плагин и нажимаем Install.

.. figure:: ../pics/grafana_setup_plugins_menu.png
    :align: center

    Установка плагина

* После установки выбираем появившийся вариант Create a MQTT Datasource.

.. figure:: ../pics/grafana_setup_plugins_menu.png
    :align: center

    Создание нового источника данных

* Для настройки нового источника данных нужно указать

   .. figure:: ../pics/grafana_setup_conf_datasource.png
      :align: center

      Настройка источника данных

   * Название источника данных
   * URL адрес для подключения к брокеру сообщений, например tcp://localhost:1883
   * Имя пользователя для авторизации в брокере
   * Пароль для авторизации в брокере

   .. warning::
      ВАЖНО! При настройке источника данных, для брокера сообщений
      должен быть открыт порт `1883` и установлен плагин для работы с протоколом mqtt
      Для RabbitMQ это плагин `rabbitmq-mqtt`

   .. note::
      Для установки плагина `rabbit-mqtt` нужно зайти в контейнер RabbitMQ выполнив в любом терминале
      команду `docker exec -it <id контейнера> bash` и далее выполнив команду `rabbitmq-plugins enable rabbitmq_mqtt`
      внутри контейнера

Отображение данных из платформы
-------------------------------
Для отображения данных из платформы необходимо:

#. Cоздать новый dashboard и панель.

.. figure:: ../pics/grafana_setup_add_dashboard.png
    :align: center

    Создание нового дэшборда

.. figure:: ../pics/grafana_setup_add_panel.png
    :align: center

    Создание новой панели

#. Настроить источник данных в панели, а именно:
   #. Указать в качестве источника MQTT
   #. Прописать необходимый topic по которому из брочека сообщений панель будет получать данный из платформы.

      .. note:: В качестве обменника для получения данный Grafana MQTT плагин использует `amq.topic`.

.. figure:: ../pics/grafana_setup_conf_panel.png
    :align: center

    Настройка источника данных в панели

После этого данные появятся и будут отображатся в панели.

.. warning:: ВАЖНО! Необходимо отключить автообновление дэшборда, если хотя бы одна панель использует MQTT плагин
   Автообновление нарушает ее работу и сбрасывает все данные, еоторые она получила до обновления.

Отправка данных из Grafana в платформу
======================================

Для отправки данных из Grafana необходимо воспользоваться плагином формы ручного ввода.

Для его работы дополнительная настройка Grafana не требуется
Подробнее про запуск, конфигурацию и работу плагина

`Плагин для формы ручного ввода в Grafana <./grafana_plugin.rst>`
